
generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}


enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PAYMENT_FAILED
  CANCELLED
}

enum ReceiptStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum WebhookOutcome {
  SUCCESS
  DUPLICATE
  VALIDATION_FAILED
  PROCESSING_FAILED
}

enum JobStatus {
  QUEUED
  ACTIVE
  COMPLETED
  FAILED
  RETRYING
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum StorageStatus {
  PENDING
  SUCCESS
  FAILED
}

// User
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(USER)
  
  // Profile
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  phone         String?
  
  emailVerified Boolean  @default(false) @map("email_verified")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  orders        Order[]
  receipts      Receipt[]
  stores        Store[]  // If user is admin
  paymentTransactions PaymentTransaction[]
  
  @@map("users")
}


// Store
model Store {
  id          String   @id @default(uuid())
  adminId     String   @map("admin_id")
  
  name        String
  description String?
  
  // Settings stored as JSON
  settings    Json     @default("{\"currency\": \"USD\", \"taxRate\": 0.075, \"timezone\": \"UTC\"}")
  
  contactEmail String? @map("contact_email")
  
  // Logo stored in Cloudinary
  logoUrl     String?  @map("logo_url")
  logoPublicId String? @map("logo_public_id")
  
  active      Boolean  @default(true)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  admin       User     @relation(fields: [adminId], references: [id])
  orders      Order[]
  receipts    Receipt[]
  paymentTransactions PaymentTransaction[]
  
  @@index([adminId])
  @@map("stores")
}

// Order
model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique @map("order_number")
  
  storeId     String      @map("store_id")
  userId      String      @map("user_id")
  
  // Line items stored as structured JSON
  items       Json        // Array of {productId, name, quantity, unitPrice, totalPrice}
  
  // Pricing breakdown
  subtotal    Int
  tax         Int
  shipping    Int
  discount    Int         @default(0)
  total       Int
  
  // Shipping address
  shippingAddress Json?   @map("shipping_address")
  
  // Order lifecycle
  status      OrderStatus @default(PENDING_PAYMENT)
  
  // Payment tracking
  paymentIntentId String? @unique @map("payment_intent_id")
  
  // Metadata
  metadata    Json?       // {ipAddress, userAgent, source}
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  paidAt      DateTime?   @map("paid_at")
  cancelledAt DateTime?   @map("cancelled_at")
  
  // Relations
  store       Store       @relation(fields: [storeId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  receipt     Receipt?    // One-to-one: order has at most one receipt
  transactions PaymentTransaction[]
  
  @@index([userId, status])
  @@index([storeId, createdAt])
  @@index([status])
  @@map("orders")
}

// Receipt
model Receipt {
  id            String   @id @default(uuid())
  receiptNumber String   @unique @map("receipt_number")
  
  // Foreign keys
  orderId       String   @unique @map("order_id")
  transactionId String   @unique @map("transaction_id")
  userId        String   @map("user_id")
  storeId       String   @map("store_id")
  
  // Order snapshot (denormalized for immutability)
  orderSnapshot Json     @map("order_snapshot")
  
  // Payment details
  paymentMethod  String?  @map("payment_method")
  paymentLast4   String?  @map("payment_last4")
  paidAt         DateTime @map("paid_at")
  amount         Int 
  currency       String   @default("NGN")
  
  // PDF generation status
  pdfGenerated        Boolean  @default(false) @map("pdf_generated")
  pdfGeneratedAt      DateTime? @map("pdf_generated_at")
  pdfGenerationAttempts Int    @default(0) @map("pdf_generation_attempts")
  pdfLocalPath        String?  @map("pdf_local_path")
  pdfSizeBytes        Int?     @map("pdf_size_bytes")
  
  // Cloudinary upload status
  cloudinaryUploaded      Boolean  @default(false) @map("cloudinary_uploaded")
  cloudinaryUploadedAt    DateTime? @map("cloudinary_uploaded_at")
  cloudinaryUploadAttempts Int     @default(0) @map("cloudinary_upload_attempts")
  cloudinaryPublicId      String?  @map("cloudinary_public_id")
  cloudinaryUrl           String?  @map("cloudinary_url")
  cloudinarySecureUrl     String?  @map("cloudinary_secure_url")
  cloudinarySignedUrl     String?  @map("cloudinary_signed_url")
  cloudinarySignedUrlExpiresAt DateTime? @map("cloudinary_signed_url_expires_at")
  
  // Email delivery status
  emailSent         Boolean  @default(false) @map("email_sent")
  emailSentAt       DateTime? @map("email_sent_at")
  emailSendAttempts Int      @default(0) @map("email_send_attempts")
  emailRecipient    String   @map("email_recipient")
  emailLastError    String?  @map("email_last_error")
  emailPermanentFailure Boolean @default(false) @map("email_permanent_failure")
  
  // Overall status
  status        ReceiptStatus @default(PENDING)
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  order         Order    @relation(fields: [orderId], references: [id])
  transaction   PaymentTransaction @relation(fields: [transactionId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  store         Store    @relation(fields: [storeId], references: [id])
  
  emailLogs     EmailLog[]
  storageLogs   CloudStorageLog[]
  
  @@index([userId, createdAt])
  @@index([storeId, createdAt])
  @@index([status])
  // Recovery query index: find stuck receipts
  @@index([pdfGenerated, cloudinaryUploaded, emailSent, createdAt])
  @@map("receipts")
}

// Payment transaction
model PaymentTransaction {
  id              String   @id @default(uuid())
  transactionId   String   @unique @map("transaction_id") // from payment provider
  
  orderId         String   @map("order_id")
  userId          String   @map("user_id")
  storeId         String   @map("store_id")
  
  provider        String   // "paystack"
  paymentIntentId String?  @map("payment_intent_id")
  
  amount          Int
  currency        String   @default("NGN")
  
  status          PaymentStatus
  
  // Payment method details
  method          String?  // "card", "bank_transfer"
  cardBrand       String?  @map("card_brand")
  cardLast4       String?  @map("card_last4")
  
  failureReason   String?  @map("failure_reason")
  
  // Webhook tracking
  webhookLogId    String?  @map("webhook_log_id")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  succeededAt     DateTime? @map("succeeded_at")
  failedAt        DateTime? @map("failed_at")
  
  // Relations
  order           Order    @relation(fields: [orderId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  store           Store    @relation(fields: [storeId], references: [id])
  webhookLog      WebhookLog? @relation(fields: [webhookLogId], references: [id])
  receipt         Receipt?
  
  @@index([orderId])
  @@index([userId, status])
  @@map("payment_transactions")
}

// Webhook logs
model WebhookLog {
  id            String   @id @default(uuid())
  webhookId     String   @unique @map("webhook_id")
  
  provider      String   // "paystack", "mock"
  eventType     String   @map("event_type")
  
  rawPayload    Json     @map("raw_payload")
  headers       Json?    // for debugging
  
  signature     String?
  signatureValid Boolean @map("signature_valid")
  
  // Processing status
  processed     Boolean  @default(false)
  processedAt   DateTime? @map("processed_at")
  processingAttempts Int  @default(0) @map("processing_attempts")
  
  // Parsed data (for easier querying)
  orderId       String?  @map("order_id")
  transactionId String?  @map("transaction_id")
  amount        Int?
  currency      String?
  paymentStatus String?  @map("payment_status")
  
  // Outcome
  outcome       WebhookOutcome?
  errorMessage  String?  @map("error_message")
  
  receivedAt    DateTime @default(now()) @map("received_at")
  expiresAt     DateTime @map("expires_at") // for auto-deletion
  
  // Relations
  transactions  PaymentTransaction[]
  
  @@index([processed, receivedAt])
  @@index([orderId])
  @@index([expiresAt]) // for cleanup job
  @@map("webhook_logs")
}

// Email logs
model EmailLog {
  id          String   @id @default(uuid())
  receiptId   String   @map("receipt_id")
  userId      String   @map("user_id")
  
  to          String
  from        String
  subject     String
  
  attempts    Int      @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at")
  
  status      EmailStatus
  
  // Provider response
  messageId   String?  @map("message_id")
  
  error       Json?    // {code, message, category}
  
  sentAt      DateTime? @map("sent_at")
  
  // Tracking
  opened      Boolean  @default(false)
  openedAt    DateTime? @map("opened_at")
  clicked     Boolean  @default(false)
  
  expiresAt   DateTime @map("expires_at")
  
  // Relations
  receipt     Receipt  @relation(fields: [receiptId], references: [id])
  
  @@index([receiptId])
  @@index([status, lastAttemptAt])
  @@index([expiresAt])
  @@map("email_logs")
}

// Cloud storage logs
model CloudStorageLog {
  id          String   @id @default(uuid())
  receiptId   String   @map("receipt_id")
  
  provider    String   // "cloudinary"
  operation   String   // "upload", "delete", "url_generation"
  
  publicId    String?  @map("public_id")
  url         String?
  secureUrl   String?  @map("secure_url")
  
  attempts    Int      @default(0)
  status      StorageStatus
  
  error       Json?    // {code, message, httpStatus}
  
  uploadedAt  DateTime? @map("uploaded_at")
  
  // File metadata
  fileSize    Int?     @map("file_size")
  format      String?  // "pdf"
  
  expiresAt   DateTime @map("expires_at")
  
  // Relations
  receipt     Receipt  @relation(fields: [receiptId], references: [id])
  
  @@index([receiptId])
  @@index([status, attempts])
  @@index([expiresAt])
  @@map("cloud_storage_logs")
}

// Jobs logs
model JobLog {
  id          String   @id @default(uuid())
  jobId       String   @unique @map("job_id") // from Bull queue
  
  queueName   String   @map("queue_name")
  jobType     String   @map("job_type")
  
  // Related entities
  receiptId   String?  @map("receipt_id")
  orderId     String?  @map("order_id")
  userId      String?  @map("user_id")
  
  // Lifecycle
  status      JobStatus
  attempts    Int      @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")
  
  // Payload
  data        Json
  
  // Timing
  queuedAt    DateTime @default(now()) @map("queued_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  failedAt    DateTime? @map("failed_at")
  
  // Results
  result      Json?
  error       Json?    // {message, stack, code}
  
  // Recovery
  isRecoveryJob Boolean @default(false) @map("is_recovery_job")
  originalJobId String? @map("original_job_id")
  
  expiresAt   DateTime @map("expires_at")
  
  @@index([queueName, status])
  @@index([receiptId])
  @@index([status, failedAt])
  @@index([expiresAt])
  @@map("job_logs")
}
